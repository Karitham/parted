{{define "content"}}

<div class="container">
  <div class="row justify-content-center">
    <div class="col-12 col-md-5 col-xl-4 my-5">
      <!-- Heading -->
      <h1 class="mb-2">Inbound</h1>

      <p class="text-muted mb-4">Adding parts to inventory</p>

      <br />

      <form method="post">
        <!-- Email address -->
        <div class="form-group mb-2">
          <label class="tlabel">Internal Order Number</label>
          <input
            id="ordernumber"
            name="ordernumber"
            type="ordernumber"
            class="form-control {{if .email_invalid }} is-invalid {{end}}"
            autofocus="true"
          />
        </div>

        <div class="form-group mb-2" id="search-group">
          <label class="tlabel">Search</label>
          <input
            id="search"
            name="search"
            type="search"
            class="form-control {{if .email_invalid }} is-invalid {{end}}"
            autofocus="true"
          />
        </div>

        <br />

        <button
          id="confirm-button"
          class="btn btn-lg btn-block btn-primary mt-2 mb-4 disabled"
        >
          Confirm
        </button>

        <script>
          let selects = [];

          $("body").on("keydown", "input, select", function (e) {
            if (e.which === 13) {
              var self = $(this);
              var selfid = self.attr("id");

              if (
                selfid == "ordernumber" ||
                selfid == "amount-" + selects.length
              ) {
                let search = $("#search");

                search.val("");
                search.focus();
              } else if (selfid == "search") {
                $.post("/json/partsearch", { search: $("#search").val() }).done(
                  (d) => {
                    let data = d.manufacturerPartNumberSearchReturn.products;
                    if (data == null) {
                      alert("element not found");
                      return;
                    }

                    selects.push(data);
                    $("#search-group").append(
                      `
                      <div class="input-group input-group mt-2" aria-label="input group">
                        <select id="select-${selects.length}"class="custom-select" aria-label="select element">
                        </select>

                        <input id="amount-${selects.length}" type="number" class="form-control ml-2" placeholder="amount" aria-label="select amount">
                      </div>
                      `
                    );

                    selects[selects.length - 1].forEach((value, index) => {
                      $(`#select-${selects.length}`).append(
                        $("<option></option>")
                          .val(index)
                          .html(value.displayName)
                      );
                    });

                    $("#amount-" + selects.length).focus();
                  }
                );
              }

              return false;
            }
          });

          $("#confirm-button").click((event) => {
            event.preventDefault();

            let selected = [];
            for (let i = 0; i < selects.length; i++) {
              selected.push({
                product: selects[i][$(`#select-${i}`).val()],
                amount: Number($(`#amount-${i}`).val()),
              });
            }

            $.post(
              "/inbound",
              JSON.stringify({
                order_number: $("#ordernumber").val(),
                data: selected,
              })
            ).done((resp) => console.log(resp));
          });
        </script>
      </form>
    </div>
  </div>
</div>

{{end}}
